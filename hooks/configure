#!/bin/bash
set -e

CONNECTION_KIT=$(snapctl get connection-kit 2>/dev/null || echo "")
SNAP_DATA="$SNAP_DATA/docker-volumes/systemd-compose-snap"

if [ -n "$CONNECTION_KIT" ]; then
    echo "Processing connection kit: $CONNECTION_KIT"
    
    # Create config directory
    mkdir -p "$SNAP_DATA/config"
    
    # Try to copy connection kit
    if cp "$CONNECTION_KIT" "$SNAP_DATA/config/" 2>/dev/null; then
        echo "Connection kit copied successfully"
        
        # Auto-start container with connection kit
        cd "$SNAP/docker-compose/systemd-compose-snap"
        
        # Load image if not loaded
        if ! docker images | grep -q systemd-greengrass; then
            docker load < image.tar.gz
        fi
        
        # Stop existing container
        docker stop systemd-snap-container 2>/dev/null || true
        docker rm systemd-snap-container 2>/dev/null || true
        
        # Start container with full automation
        docker run -d --name systemd-snap-container \
          --tmpfs /tmp --tmpfs /run --tmpfs /run/lock \
          -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
          -v "$SNAP_DATA/config:/etc/greengrass" \
          -v "$SNAP_DATA/lib:/var/lib/greengrass" \
          -v "$SNAP_DATA/components:/opt/aws/iot/greengrass/components" \
          --restart on-failure \
          systemd-greengrass:latest
        
        # Wait and setup
        sleep 20
        docker exec systemd-snap-container /bin/bash -c "
        cd /etc/greengrass && unzip -o *.zip
        sed -i -e 's:{{config_dir}}:/etc/greengrass:g' -e 's:{{nucleus_component}}:aws.greengrass.NucleusLite:g' config.yaml
        chown ggcore:ggcore *.pem* config.yaml
        chmod 644 device.pem.crt AmazonRootCA1.pem && chmod 600 private.pem.key
        systemctl start greengrass-lite.target
        "
        
        echo "✅ Greengrass Lite started automatically!"
        echo "Check status: docker exec systemd-snap-container systemctl list-units | grep ggl"
        
    else
        echo "❌ Cannot access $CONNECTION_KIT"
        echo "Please copy manually:"
        echo "sudo cp $CONNECTION_KIT $SNAP_DATA/config/"
    fi
else
    echo "Set connection kit: sudo snap set systemd-compose-snap connection-kit=/path/to/kit.zip"
fi
